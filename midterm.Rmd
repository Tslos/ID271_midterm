---
title: "Midterm"
author: "Tillie Slosser"
date: "2026-02-18"
output: html_document
---

```{r setup, include=FALSE, message = FALSE, warnings = FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# NOTE: this is a rough sketch of how we might lay out the final product based on the instructions, but we can change things around at any time.

## Section 1. Data Processing & Exploration

here, we will read in the data, do some processing, and maybe a fun visualization

```{r}
library(tidyverse)
library(knitr)
library(mgcv)
library(splines)

#read in data
df <- read.csv( './ID271_midterm/hou_pm.csv') |> 
  drop_na() |> #drop NA observations now - we would drop them when 
               # fitting models anyway, and this means that when calculating # of dfs to  
               # adjust for time, we will have right number of data-giving years to count
  mutate(date = mdy(date),
         year = year(date),
         date_num = as.numeric(date - min(date)+1))
```

## Section 2. Methodology & Analysis

#### Outline, for the sake of making sure our methods line up with the analysis we want to do:

-   Talking about the data paragraph: what we've got, what covariates we are including (all of em)
-   Sentence about time series data, why they are hard to deal with, e.g. they have long & short term temporal trends, seasonality, day of the week, etc etc. Possibly even direct quote the example he keeps bringing up about "more people die in the winter, so if you look at something that is summer-specific, it will look protective without proper adjustment for season"
-   Sentence about how deaths are count data, ergo we should use the Poisson distribution. Option sentence about using quasipoisson distribution if we decide that
-   Sentence about how splines are neat and let us make fewer assumptions, then mention that we fit penalized splines to our exposure (PM2.5) and non-date continuous covariates(temp, relative humid) and fit a spline with 4 degrees of freedom per year for date to capture seasonal variation
    -   answer the bonus question by talking about how fitting a spline for time with 4 df per year is preferred because it avoids over complicating the model (not too wiggly) via incorporating physical knowledge that there are 4 seasons in a year (at least in the US, we are not getting into the whole "dry vs wet" season modeling conundrum)
-   Brief mention that we include day of week as a factor, because workday = commuters = more cars = more pm2.5
-   Small aside about how we are including temperature because it can influence daily death in the short-term (e.g. heat wave / cold snap), so we want to include it so that we can make sure that our estimate for PM2.5 is not accidentally capturing the effect of temperature instead.

```{r}
## Explore distribution of mortality
# First, pivot the data for easier visualization within GGplot
df_long <- df |> 
  pivot_longer(cols= c('tot', 'cvd', 'resp'), 
               names_to = 'death_cat',
               values_to = 'death_count') |> 
  mutate(death_cat = case_when(death_cat=='tot' ~ 'Total',
                               death_cat=='cvd' ~ 'Cardiovascular',
                               death_cat=='resp' ~ 'Respiratory')) 
  #make plot
  ggplot(df_long)+
  geom_density(aes(x = death_count), color = '#82667F', fill = '#B486AB', alpha = 0.5) +
  facet_wrap(~death_cat)+
  labs(title = 'Daily Mortality in Houston',
       x = 'Num. Deaths',
       y = 'Density')+
  theme_bw()

testing_quasipoisson <- df_long |> 
  group_by(death_cat) |> 
  summarise(Mean = mean(death_count),
            Variance = var(death_count))

kable(testing_quasipoisson, col.names = c('', 'Mean', 'Variance'))
```

Tillie thinks we should use (quasi) poisson just because it's count data, but we might want to mention how one might be able to argue that total mortality is normal-ish? Should we talk to Joel about this?

Also, I (still tillie) generally default to assuming quasipoisson will be a better approximation of real life, but our means are pretty close to our variances, so we might want to reconsider\

```{r}
num_years <- length(unique(df$year))

# Make models
tot_mod <- gam(tot ~ s(pm25) + # penalized spline for PM2.5, then adjust for...
                     s(date_num, bs = "cr",fx=TRUE,k=num_years*4+1) + #time: fixed cubic spline
                     s(TEMP, bs = "cr", fx=FALSE) + #temperature, penalized
                     s(RH, bs = "cr", fx=FALSE) + #relative humidity, penalized
                     as.factor(dow), #factor: day of week
               family=quasipoisson,
               data=df
               )

cvd_mod <- gam(cvd ~ s(pm25) + # penalized spline for PM2.5, then adjust for...
                     s(date_num, bs = "cr",fx=TRUE,k=num_years*4+1) + #time: fixed cubic spline
                     s(TEMP, bs = "cr", fx=FALSE) + #temperature, penalized
                     s(RH, bs = "cr", fx=FALSE) + #relative humidity, penalized
                     as.factor(dow), #factor: day of week
               family=quasipoisson,
               data=df
               )

resp_mod <- gam(resp ~ s(pm25) + # penalized spline for PM2.5, then adjust for...
                     s(date_num, bs = "cr",fx=TRUE,k=num_years*4+1) + #time: fixed cubic spline
                     s(TEMP, bs = "cr", fx=FALSE) + #temperature, penalized
                     s(RH, bs = "cr", fx=FALSE) + #relative humidity, penalized
                     as.factor(dow), #factor: day of week
               family=quasipoisson,
               data=df
               )


```

## Section 3.

#### Outline, for the sake of making sure our methods line up with the analysis we want to do:

-   Talk about the dose-response curves (plotted below).

-   report RR or other descriptor of association for 10 $\mu g/m^{3}$ increase in PM2.5 for each type of death - calculations TBD once we decide on a final model.

-   If we settle on a model that does not do lagged PM, then talk about how we made the assumption that PM only has a same-day effect, which isn't realistic but makes modeling easier.

```{r}
#plotting the dose-responses
plot(tot_mod, select = 1)
title('Effect of PM2.5 on Daily Total Mortality')

plot(cvd_mod, select = 1)
title('Effect of PM2.5 on Daily Cardiovascular Mortality')

plot(resp_mod, select = 1)
title('Effect of PM2.5 on Daily Respiratory Mortality')
```
